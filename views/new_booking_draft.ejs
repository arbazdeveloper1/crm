<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
  <title> Admin Dashboard </title>
  <!-- General CSS Files -->
  <link rel="stylesheet" href="/assets/css/app.min.css">
  <link rel="stylesheet" href="/assets/bundles/izitoast/css/iziToast.min.css">
  <!-- Template CSS -->
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <!-- Custom style CSS -->
  <link rel="stylesheet" href="/assets/css/custom.css">
  <script src="/assets/bundles/izitoast/js/iziToast.min.js"></script>
</head>

<body>
  <div class="loader"></div>
  <% if(email==='true' ) { %>
    <nav class="navbar navbar-expand-lg bg-primary " style="margin-left: -13%; z-index: 1000;">
      <a href="#" class="btn btn-success mx-2" data-toggle="modal" data-target="#exampleModal">Send Email Now</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item  mx-2 active">
            <a href="#" class="btn btn-warning" data-toggle="modal" data-target="#exampleModal3">Attechments</a>
          </li>
          <li class="nav-item mx-2">
            <% if(userRole=='agent' ) { %>
              <% if(result[0].Docusign_Verified=='true' ) { %>
                <a href="#" class="btn btn-danger" id="change_status"><i
                    class="fas fa-<%= result[0].status === 'sent_for_issuance' ? 'unlock' : 'lock' %>"></i>&nbsp;&nbsp;Last
                  Status: <%- result[0].status==='sent_for_issuance' ? "Send for Issuance" : "working" %></a>
                <% } else { %>
                  <a href="#" class="btn btn-danger" id="alert_for_verfication"><i class="fas fa-lock"></i> Last
                    Status: Working</a>
                  <% } %>
                    <% } %>

                      <% if (userRole=='admin' && result[0].status==="sent_for_issuance" ) { %>
                        <a href="#" class="btn btn-warning" data-toggle="modal" data-target="#chargeModal">Last Status:
                          Charged</a>
                        <% } else if (userRole=='admin' ) { %>
                          <a href="#" class="btn btn-warning" data-toggle="modal" data-target="#chargeModal">Last
                            Status: Charged</a>
                          <% } else if (charging_status=='charged' ) { %>
                            <a href="#" class="btn btn-success" data-toggle="modal" data-target="#chargeModal">Last
                              Status: Charged</a>
                            <% } %>

          </li>
          <li class="nav-item mx-2">
            <a href="#" class="btn btn-info">Booking Remarks</a>
          </li>
          <li class="nav-item mx-2">
            <a href="#" class="btn btn-warning" data-toggle="modal" data-target="#exampleModal2">Change Currency</a>
          </li>
          <li class="nav-item mx-2">
            <a href="#" class="btn btn-success">Fetch Score</a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item mx-2">
            <a href="/all_booking" class="btn btn-danger">Back to Home</a>
          </li>
        </ul>
      </div>
    </nav>



    <div class="container-fluid bg-primary">
      <div class="w-100 " style="height: 300px">

      </div>
    </div>


    <div class="container-fluid justify-content-center d-flex " style="margin-top: -10%;">
      <div class="row ">
        <div class="col-12 ">
          <tbody>
            <tr>
              <td bgcolor="#2b0495" align="center">
                <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 800px;">
                  <tbody>
                    <tr>
                      <td align="center" valign="top" style="padding: 0px 10px 40px 10px;"> </td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
            <tr>
              <% } %>
                <td bgcolor="#2b0495" align="center" style="padding: 0px 10px 0px 10px;">
                  <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 800px;">
                    <tbody>
                      <tr>
                        <td bgcolor="#ffffff" align="left" valign="top"
                          style="padding: 40px 20px 20px 20px; border-radius: 4px 4px 0px 0px; color: #666666; font-family: 'Lato', Helvetica, Arial, sans-serif;">
                          <h1 style="font-size: 18px; font-weight: 400; margin: 2;">
                            <b>Dear <%- result[0]?.card_holder_name %> , </b><br><br><span
                              style="font-size:15px;">Greetings of the day! </span>
                          </h1>
                          <br><b>Subject: </b> <%- result[0]?.subject_line || "No Subject" %> <br>
                        </td>
                        <td bgcolor="#ffffff" align="right" valign="top"
                          style="padding: 40px 20px 20px 20px; border-radius: 0px 4px 0px 0px; color: #111111;"
                          lato",="" helvetica,="" arial,="" sans-serif;="" font-size:="" 48px;="" font-weight:=""
                          200;="" letter-spacing:="" 2px;="" line-height:="" 48px;"="">

                          <h1 style="font-size: 15px; color:green;font-weight: 400; margin: 2;">
                            <% if(email==='true' ) { %>
                              <% if(result[0]?.Docusign_Verified !='false' ) { %>
                                <a href="/pdfupload/<%- result[0]?.signed_document %>" target="_blank"><i
                                    style="color:green" class="fa fa-check-circle"></i><b> Docusign Verified
                                  </b></a> <br><br>
                                <% }else{ %>
                                  <i style="color:red" class="fa fa-times-circle"></i><b style="color: red;"> Docusign
                                    Verified </b><br><br>
                                  <% } %>
                                    <% } %>
                          </h1>
                          </a>

                        </td>
                      </tr>
                    </tbody>
                  </table>
                </td>
            </tr>
            <tr>
              <td bgcolor="#ededed" align="center" style="padding: 0px 10px 0px 10px;">
                <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 800px;">
                  <tbody>
                    <tr>
                      <td bgcolor="#ffffff" align="left" style="padding: 20px 30px 40px 30px; color: #666666;">
                        <p style="margin: 0; color:#666666;">We would like you to go through your itinerary carefully.
                          Please reply to
                          this
                          email as "I Authorize or I Agree" only when you have checked all the information and you are
                          completely satisfied with the itinerary and price. As per our conversation and as agreed, we
                          have
                          booked your itinerary as follows -
                          <br><br>
                          Total price for all passenger(s) including taxes and fees: <b>$ <%- result[0]?.total_amount %>
                              <%- result[0]?.currency %></b> (Total for all
                          passengers) and the same amount would be charged on your Visa card ending with <%-
                            result[0]?.card_number.replace(/\d(?=\d{4})/g, "X" ) || "No card available" %>
                            <br>

                            <% result?.forEach((row, index)=> {
                              let airline_data;
                              try {
                              airline_data = JSON.parse(row.airline_info)
                              } catch (error) {
                              airline_data = [];
                              }

                              let chargeCount = airline_data.length;
                              %>

                              <br> On your bank statement, there would be
                              <%= chargeCount===1 ? "one charge" : chargeCount + " charges" %>,

                                <% airline_data.forEach((airline, pIndex)=> { %>
                                  <%= pIndex===0 ? "one from" : ", one from" %>
                                    <%= airline.airline_name %> for <%= airline.airline_cost %>
                                        <%= row.currency %>
                                          <% }); %>
                                            would be shown under <%- result[0]?.mco_description=='my_fly_support'
                                              ? 'My Fly Support' : result[0]?.mco_description %>.
                                              <br><br>

                                              <% }); %>

                                                <b style="color:#024;">Confirmation : </b><%- result[0]?.customer_id %>
                                                  <input type="hidden" name="customer_id" id="customer_id"
                                                    value="<%- result[0]?.customer_id %>">
                        </p>
                      </td>
                    </tr>
                    <tr>
                      <td bgcolor="#ffffff" align="left" style="padding: 0px 30px 20px 30px; color: #666666; ">
                        <p style="margin: 0;">

                          <b style="color:#024;">Passenger(s) information â€“</b><br><br>
                        <table style="background: #d2d2d2; border: solid 1px #d2d2d2;" width="100%" cellspacing="0"
                          cellpadding="0" border="0">
                          <thead>
                            <tr style="color: #000;font-weight:600">
                              <td
                                style="font-size: 14px; line-height: 25px;  border-right: solid 1px #ffffff;padding:10px;"
                                width="10%">
                                Sr. No.

                              </td>
                              <td
                                style="font-size: 14px; line-height: 25px;  border-right: solid 1px #ffffff;padding:10px;"
                                width="20%">
                                Full Name

                              </td>
                              <td
                                style="font-size: 14px; line-height: 25px;  border-right: solid 1px #ffffff;padding:10px;"
                                width="20%">
                                DOB (D,M Y)
                              </td>

                            </tr>
                          </thead>
                          <tbody>

                            <% result?.forEach((row, index)=> {
                              let passengers = JSON.parse(row.passenger_details); // Parse the JSON string
                              passengers.forEach((passenger, pIndex) => {
                              %>

                              <tr bgcolor="#ffffff">
                                <td
                                  style="font-size: 13px; line-height: 25px;  border-right: solid 1px #d3d2d2;padding:10px;"
                                  width="10% !important">
                                  <%= pIndex + 1 %>.
                                </td>
                                <td
                                  style="font-size: 13px; line-height: 25px;  border-right: solid 1px #d3d2d2;padding:10px;"
                                  width="30% !important">
                                  <%= passenger.fullName %>
                                    <%= passenger.ticketNo !="" ? `(Ticket No: ${passenger.ticketNo})` : '' %>
                                </td>
                                <td
                                  style="font-size: 13px; line-height: 25px;  border-right: solid 1px #d3d2d2;padding:10px;"
                                  width="30% !important">
                                  <%= new Date(passenger.dob).toLocaleDateString('en-GB', { day: '2-digit' ,
                                    month: '2-digit' , year: 'numeric' }).replace(/\//g, '-' ) %>
                                </td>



                              </tr>
                              <% }); }); %>
                          </tbody>
                        </table><br><br>
                        <br><br>

                        <b style="color:#024;">Trip Details â€“</b><br><br>
                        </p>
                        <p>

                          <% const images=result[0]?.image.split(','); %>
                            <% images?.forEach(image=> { %>
                              <% if (image.trim()) { %>
                                <img style="width: 546px; margin-bottom: 10px;"
                                  src="http://localhost:3000/uploads/<%= image.trim() %>" alt="Trip Details"><br>
                                <% } %>
                                  <% }); %>


                        </p>
                        <p></p>

                        <br><br><span style="font-weight: bolder; color: rgb(255, 87, 51);">Credit Card Authorization
                          :</span><br><br>

                        <style type="text/css">
                          .tg {
                            border-collapse: collapse;
                            border-spacing: 0;
                          }

                          .tg td {
                            border-color: black;
                            border-style: solid;
                            border-width: 1px;
                            font-family: Arial, sans-serif;
                            font-size: 14px;
                            overflow: hidden;
                            padding: 10px 5px;
                            word-break: normal;
                          }

                          .tg th {
                            border-color: black;
                            border-style: solid;
                            border-width: 1px;
                            font-family: Arial, sans-serif;
                            font-size: 14px;
                            font-weight: normal;
                            overflow: hidden;
                            padding: 10px 5px;
                            word-break: normal;
                          }

                          .tg .tg-0lax {
                            text-align: left;
                            vertical-align: top
                          }
                        </style>
                        <table class="tg">
                          <thead>
                            <tr>
                              <th class="tg-0lax"><b>BOOKING PNR:</b></th>
                              <th class="tg-0lax"><%- result[0]?.gds_pnr %></th>
                            </tr>
                          </thead>
                          <tbody>

                            <tr>
                              <td class="tg-0lax"><b>TOTAL CHARGES:</b></td>
                              <td class="tg-0lax"><%- result[0]?.total_amount %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>BASE FARE:</b></td>
                              <td class="tg-0lax"><%- BaseFare %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>TAXES &amp; FEES:</b></td>
                              <td class="tg-0lax"><%- result[0]?.mco_calculated %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>REASON OF BOOKING:</b></td>
                              <td class="tg-0lax">New Booking</td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>AIRLINE REFERENCE (ARL):</b></td>
                              <td class="tg-0lax"><%- result[0]?.arl_confirmation %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>CARD HOLDER NAME:</b></td>
                              <td class="tg-0lax"><%- result[0]?.card_holder_name %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>CARD NUMBER:</b></td>
                              <td class="tg-0lax"><%- result[0]?.card_number %> (<%- result[0]?.card_type %>)</td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>CARD EXPIRY / CVV:</b></td>
                              <td class="tg-0lax"><%- result[0]?.expiration %> &nbsp;&nbsp;&nbsp; | &nbsp;&nbsp; <%-
                                    result[0]?.cvv %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>BILLING PHONE:</b></td>
                              <td class="tg-0lax"><%- result[0]?.billing_phone %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax"><b>BILLING EMAIL:</b></td>
                              <td class="tg-0lax"><%- result[0]?.email %></td>
                            </tr>
                            <tr>
                              <td class="tg-0lax" colspan="2"><b>BILLING ADDRESS OF CARD:</b> <%-
                                  result[0]?.billing_address %></td>
                            </tr>
                          </tbody>
                        </table>

                        <br><br><span style="font-weight: bolder; color: rgb(255, 87, 51);">Terms And
                          Conditions:</span><br>
                        <span style="font-size:12px;"> Reservations are non-transferable and non-refundable. </span>

                      </td>
                    </tr>

                    <tr>
                      <td bgcolor="#ffffff" align="left"
                        style="padding: 10px 30px 40px 30px; border-radius: 0px 0px 4px 4px; color: #666666;">
                        <p style="margin: 0;"><b>Thanks &amp; Regards!</b> <br>
                          <span style="color:green;font-size:20px;"><%- FullName %></span> <br>
                          (Reservations Desk)<br>
                        </p>
                        <hr>

                        â˜Ž <b>Toll-free (24/7) :</b>&nbsp;&nbsp; <a href="#"
                          style="font-weight:bold;">1-855-515-1040</a><br><br>
                        <!-- <a href="/" style="color:white;background-color:green;padding:8px;border:1px solid black;text-decoration:none;">I
                      Acknowledge</a> -->
                        <input type="hidden" name="customer_id" value="<%= result.customer_id %>">
                        <% if(email=='false' ) { %>
                          <div style="display: flex; align-items: center; gap: 15px;">
                            <a href="http://localhost:3000/api/TrackIp/<%- result[0]?.customer_id %>"
                              style="color:white;background-color:green;padding:8px;border:1px solid black;text-decoration:none;">
                              I Acknowledge
                            </a>


                            <a href="http://localhost:3000/customer_doc_upload/<%- encodeURIComponent(result[0]?.customer_id) %>"
                              style="color:white;background-color:black;padding:8px;border:1px solid green;text-decoration:none;padding:8px;">
                              Upload Files
                            </a>

                          </div>
                          <% } %>


                            <p></p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
            <tr>
              <td bgcolor="#ededed" align="center" style="padding: 30px 10px 0px 10px;">
                <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 800px;">
                  <tbody>
                    <tr>
                      <td bgcolor="#FFECD1" align="center"
                        style="padding: 30px 30px 30px 30px; border-radius: 4px 4px 4px 4px; color: #666666;">
                        <h2 style="font-size: 20px; font-weight: 400; color: #111111; margin: 0;">CHANGES / CANCELLATION
                        </h2>
                        <p style="margin: 0;font-size: 12px;">
                          <b>Terms &amp; Conditions</b>
                          Acknowledgment of these terms and conditions is a condition of booking. Acceptance by you on
                          this
                          booking is your acceptance that you have read, understood and agreed to be bound by these
                          terms and
                          conditions.
                          <br><br>
                          <b>Reconfirmation</b>
                          We recommend that you confirm your flight with the local airline office at least 72 hours
                          prior to
                          departure. Failure to reconfirm may result in the cancellation of some reservations. For
                          Special
                          request (hotel confirmation, meal and seat preference, special assistance, wheel chair
                          request) are
                          subject to airline confirmation and need to reconfirm from agency at least 72 hours prior to
                          departure.
                          <br><br>
                          <b>CHANGES / CANCELLATION</b>
                          Reservations are non-transferable and non-refundable. Some tickets, depending on fare rules,
                          can be
                          refunded and/or used (for a limited time) towards future travel or can be refunded; however,
                          all
                          applicable penalties will apply (airline charges and service fees). Travelers Name â€“
                          Traveller's First
                          name and Last name must be entered during the time of reservation exactly as it appears on
                          your
                          government-issued identification, be it your passport, Driving License or other acceptable
                          forms of
                          identification depending on your type of journey (Domestic/International). Travel agency
                          refund (once
                          the refund is processed by the airline, we wont be taking any chargeback for the same). The
                          name once
                          entered will not be changed. Some Typo Error (Name Correction) however, is allowed, depending
                          on
                          Airline Terms of Use, &amp; charges would be applied according to airline policy. We are a
                          travel
                          agency and not the airlines. This email has been sent on behalf of My Fly Support LLC. We are
                          happy to
                          help you with any questions or concerns you may have. All customers are advised to verify
                          travel
                          documents (transit visa/entry visa) for the country through which they are transiting and/or
                          entering.
                          We will not be responsible if proper travel documents are not available and you are denied
                          entry or
                          transit into a Country. We request you to consult the embassy of the country(s) you are
                          visiting or
                          transiting through. In the booking made by the agency or any third party , once the refund is
                          processed by the airline, you have to contact to your travel agency for the refund amount as
                          refund
                          amount is being sent to the Travel Agency , we wont be taking any chargeback in case of Third
                          Party
                          Booking refund.<br><br> <span style="color:red;">If you have any query or dispute call on and
                            we will
                            give our best resolution to the dispute hence we will not cater any direct dispute from
                            bank!</span>
                          <br><br>
                          <b>DECLARATION</b>
                          If My Fly Support LLC takes any action to enforce the Terms and Conditions, it will be
                          entitled to
                          recover from you, and you agree to pay, all legal fees and expenses and any cost of
                          litigation, in
                          addition to any other relief, at law or in equity, to which such parties may be entitled. I
                          agree that
                          the above dates and time are correct. My name is as it appears on the passport. I am aware of
                          all fare
                          rules and conditions. I must reconfirm my flights 72 hours prior to departure.
                        </p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </tbody>
        </div>
      </div>
    </div>





    <!-- Send email modal start  -->
    <% if(email==='true' ) { %>
      <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="formModal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="formModal">Send Details to Passenger</h5>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"
                style="outline: none;">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class=" tabs-left" id="modal-tabs">
                <ul class="nav nav-tabs">
                  <li class="active">
                    <a href="#personal" data-toggle="tab">Send Email</a>
                  </li>
                </ul>
              </div>
              <div class="tab-content" id="tab-content">
                <div class="tab-pane active" id="personal">
                  <!-- <form action="/" method="POST"> -->
                  <div class="row" style="margin-top:2%">
                    <div class="col-sm-12" style="margin-bottom:3%">
                      <label for="fromemail" class="col-form-label">From:</label>
                      <select name="fromemail" id="fromemail" class="form-control">
                        <option value="" disabled>Select</option>
                        <option value="ravi.vermaa120@gmail.com">support@myflysupports.com</option>
                        <option value="support@kingjourney.com">support@kingjourney.com</option>
                      </select>
                    </div><br>
                    <div class="col-sm-12">
                      <label for="recipient-name" class="col-form-label">Subject:</label>
                      <input type="text" name="subject" class="form-control" id="mailsubject"
                        placeholder="Enter Subject..." autocomplete="off" required="">

                    </div>

                    <div class="col-sm-12">
                      <br>

                      <label for="recipient-name" class="col-form-label">Email Address:</label>
                      <input type="email" name="to_email" class="form-control" id="email"
                        placeholder="Enter Customer Email Id.." autocomplete="off" value="<%- result[0]?.email %>"
                        required="" disabled>
                      <p id="error"></p>
                      <input type="hidden" value="1032" name="id">
                    </div>
                    <div class="col-sm-12" style="margin-bottom:3%">
                      <label for="eticketfile" class="col-form-label">Select E-Ticket:</label>
                      <select name="eticketfile" id="eticketfile" class="form-control" multiple
                        style="min-height: 100px;">
                        <option value="" disabled>Select Attachments</option>
                      </select>
                      <small class="text-muted">Hold Ctrl to select multiple files</small>
                    </div>

                    <div class="col-sm-12">
                      <div class="row">
                        <div class="col-sm-4">
                          <div class="form-check">
                            <input class="form-check-input" type="radio" value="email" name="emailtype"
                              id="emailTypeAuth" checked>
                            <label class="form-check-label" for="emailTypeAuth">
                              Auth Email
                            </label>
                          </div>
                        </div>
                        <div class="col-sm-4">
                          <div class="form-check">
                            <input class="form-check-input" type="radio" value="ticket" name="emailtype"
                              id="emailTypeTicket">
                            <label class="form-check-label" for="emailTypeTicket">
                              e-Ticket
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <br><br>

                    <div class="col-sm-12 col-xl-12" style="text-align:right;margin-top:5%">
                      <button type="button" class="btn btn-outline-secondary" style="text-align:right"
                        data-dismiss="modal" id="closeModal">Close</button>
                      <!-- <button type="button" id="check_email" style="text-align:left" class="btn btn-warning">Check
                            Email</button> -->
                      <button type="submit" class="btn btn-primary" style="text-align:right" id="MailSendButton">Send
                        Now</button>
                    </div>
                  </div>
                  <!-- </form> -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Send email start -->
      <% } %>


        <!-- Currency change modal start -->
        <% if(email==='true' ) { %>
          <div class="modal fade" id="exampleModal2" tabindex="-1" role="dialog" aria-labelledby="formModal2"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title" id="formModal2">Change Currency</h5>
                  <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"
                    style="outline: none;">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="currency">Select Currency</label>
                    <select class="form-control" id="currency" name="currency">
                      <option value="USD">USD - US Dollar</option>
                      <option value="EUR">EUR - Euro</option>
                      <option value="GBP">GBP - British Pound</option>
                      <option value="CAD">CAD - Canadian Dollar</option>
                      <!-- Add more currency options as needed -->
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id="changeCurrencyBtn">Update Currency</button>
                </div>
              </div>
            </div>
          </div>
          <% } %>

            <!-- Currency change modal end -->


            <!-- Attachments modal -->
            <% if(email==='true' ) { %>
              <div class="modal fade" id="exampleModal3" tabindex="-1" role="dialog"
                aria-labelledby="attachmentsModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title" id="attachmentsModalLabel">Attachments & Documents</h5>
                      <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <div class="modal-body">
                      <!-- Nav tabs -->
                      <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                          <a class="nav-link active" data-toggle="tab" href="#recording" role="tab">E-Tickets</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" data-toggle="tab" href="#attachment" role="tab">Attachments</a>
                        </li>
                      </ul>

                      <!-- Tab content -->
                      <div class="tab-content mt-3">

                        <!-- E-Tickets tab -->
                        <div class="tab-pane fade show active" id="recording" role="tabpanel">
                          <div class="scroll-container mb-4" style="max-height: 250px; overflow-y: auto;">
                            <div class="list-group" id="eTicketsList"></div>
                          </div>

                          <!-- Upload form -->
                          <!-- <form id="uploadForm"> -->
                          <div class="form-group">
                            <div class="row">
                              <div class="col-md-6">
                                <input type="text" class="form-control" id="fileName" placeholder="Enter File Name"
                                  required>
                              </div>
                              <div class="col-md-6">
                                <input type="file" class="form-control" id="fileInput" required>
                              </div>
                            </div>
                          </div>

                          <div class="text-right">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" id="uploadForm">Upload</button>
                          </div>
                          <!-- </form> -->
                        </div>
                        <!-- Attachments tab -->
                        <div class="tab-pane fade " id="attachment" role="tabpanel">
                          <div class="mb-4">
                            <h6 class="font-weight-bold">Attachments by Agent</h6>
                            <div class="list-group" id="attachmentsList"></div>
                          </div>

                          <% if (result[0] && result[0].uploaded_document) { let
                            documents=result[0].uploaded_document.split(',').map(doc=> doc.trim()).filter(doc => doc);
                            if (documents.length > 0) {
                            %>
                            <h6 class="font-weight-bold" style="margin-bottom: 10px;">ðŸ“Ž Attachments by User</h6>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                              <% documents.forEach(doc=> {
                                let filePath = `/uploads/${doc}`; // Assuming files are in 'uploads' folder
                                let fileName = doc.split('/').pop(); // Get actual file name
                                let fileExtension = fileName.split('.').pop().toLowerCase();
                                let isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension);
                                %>
                                <!-- Stylish Button for Image or PDF -->
                                <a href="<%= filePath %>" target="_blank"
                                  style="display: flex; align-items: center; justify-content: center; 
                                        padding: 4px 8px; border-radius: 5px; text-decoration: none; 
                                        background-color: <%= isImage ? '#007bff' : '#28a745' %>; 
                                        color: white; font-weight: bold; border: none; cursor: pointer;font-size: 12px;">
                                  <%= isImage ? 'ðŸ–¼ï¸ ' : 'ðŸ“„ ' %>
                                    <%= fileName %>
                                </a>
                                <% }); %>
                            </div>
                            <% } } %>

                        </div>


                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <% } %>
                <!-- attechment modal close -->


                <!-- charge modal -->
                <% if(email==='true' ) { %>
                  <div class="modal fade" id="chargeModal" tabindex="-1" role="dialog"
                    aria-labelledby="chargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content ">
                        <div class="modal-header bg-primary">
                          <h4 style="font-size:18px;color:white;" class="modal-title">Update Booking Status</h4>
                        </div>
                        <div class="modal-body">
                          <div class="row">
                            <div class="col-sm-4">
                              <label for="recipient-name" class="col-form-label">Payment Status:</label>
                              <select name="status_admin" class="form-control" id="payment_status" required="">
                                <option value="" hidden="">--Choose--</option>
                                <option value="charged">Charged</option>
                                <option value="declined">Declined</option>
                                <option value="invalid">Invalid</option>
                                <option value="voided">Voided</option>
                                <option value="others">Others</option>
                                <option value="insufficient_fund">Insufficient Funds</option>
                                <option value="pickup">Pickup</option>
                                <option value="chargeback">Chargeback</option>
                                <option value="partaly_refund">Partaly Refund</option>
                                <option value="refund">Refund</option>
                                <option value="cb_alert">CB Alert</option>
                              </select>

                              <input type="hidden" value="1108" name="eid">
                              <input type="hidden" value="KNOVA WOOTEN" name="cch">
                              <input type="hidden" value=" 44GKJ3" name="pnr">
                              <input type="hidden" value=" 44GKJ3" name="arc">
                              <input type="hidden" value="Nathan" name="agent">
                              <input type="hidden" value="4402511877" name="phone">
                              <input type="hidden" value="donniedanko16@gmail.com" name="email">
                              <input type="hidden" value="607.96" name="ticket_cost">
                              <input type="hidden" value="538.24" name="mco">
                              <input type="hidden" value="1" name="email_status">
                              <input type="hidden"
                                value="https://crm.kingjourney.com/admin/draft/view-new_bookings.php?eid=1108&amp;email_type=1&amp;email_live=preview"
                                name="booking_url">
                            </div>
                            <div class="form-group col-sm-4">
                              <label for="recipient-name" class="col-form-label">Customer Name:</label>
                              <input type="text" class="form-control" id="card_holder_name"
                                value="<%- result[0]?.card_holder_name %>" autocomplete="off" readonly="">
                            </div>

                            <div class="form-group col-sm-4">
                              <label for="recipient-name" class="col-form-label">Confirmation / ARL:</label>
                              <input type="text" class="form-control" id="customer_id"
                                value="<%- result[0]?.customer_id %>" autocomplete="off" readonly="">
                            </div>

                          </div>
                          <div class="row">
                            <div class="form-group col-sm-6">
                              <label for="recipient-name" class="col-form-label">Queue name:</label>
                              <select name="call_source" class="form-control" id="queue_name" required="">
                                <option value="" hidden="">--Choose--</option>
                                <option value="Own_gtf">Own GTF</option>
                              </select>
                            </div>
                            <div class="form-group col-sm-6">
                              <label for="recipient-name" class="col-form-label">Charging Source:</label>
                              <select name="charge_source" class="form-control" id="charging_source" required="">
                                <option value="" hidden="">--Choose--</option>
                                <option value="my_fly_support">My Fly Support</option>
                                <option value="air_ticket_pro">Air Ticket Pro</option>
                              </select>
                            </div>
                          </div>
                          <div class="row">
                            <div class="form-group col-sm-4">
                              <label for="recipient-name" class="col-form-label">Card Verified:</label>
                              <select name="card_verified" class="form-control" id="verfication" required="">
                                <option value="" hidden="">--Choose--</option>
                                <option value="yes">Yes</option>
                                <option value="no" selected="">No</option>
                              </select>
                            </div>
                            <div class="form-group col-sm-4">
                              <label for="recipient-name" class="col-form-label">Company Card Used:</label>
                              <select name="card_used" class="form-control" id="companycard" required="">
                                <option value="" hidden="">--Choose--</option>
                                <option value="yes">Yes</option>
                                <option value="no" selected="">No</option>
                              </select>
                            </div>
                            <div class="form-group col-sm-4">
                              <label for="recipient-name" class="col-form-label">Card Number:</label>
                              <input type="text" class="form-control" maxlength="10" name="card_num" id="cardnum"
                                value="<%- result[0]?.card_number.slice(-4) || " No card available" %>"
                              placeholder="Enter Last 4 Digit" autocomplete="off" readonly="">
                            </div>
                          </div>
                          <div class="row">
                            <div class="form-group col-sm-6">
                              <label for="recipient-name" class="col-form-label">Voucher Used:</label>
                              <select name="voucher_used" class="form-control" id="voucher" required="">
                                <option value="" hidden="">--Choose--</option>
                                <option value="yes">Yes</option>
                                <option value="no" selected="">No</option>
                              </select>
                            </div>
                            <div class="form-group col-sm-6">
                              <label for="recipient-name" class="col-form-label">Amount:</label>
                              <input type="text" class="form-control" name="vamount" id="amount"
                                value="<%- result[0]?.total_amount %>" placeholder="Enter Amount" autocomplete="off"
                                readonly="">
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-sm-12">
                              <textarea name="payment_remarks" placeholder="Enter Payment Remarks (if Any)"
                                class="form-control" id="remarks"></textarea>
                            </div>
                          </div>

                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                          <button type="submit" class="btn btn-primary" id="updatebokingstatus">Update Now</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% } %>
                    <!-- charge modal close -->

                    <!-- ----- ----------------------- Function to Send the Mail start ----------------------- -->

                    <script>
                      let BookingStatusBtn = document.getElementById('updatebokingstatus')
                      BookingStatusBtn.addEventListener('click', function () {
                        let payment_status = document.getElementById('payment_status').value;
                        let card_holder_name = document.getElementById('card_holder_name').value;
                        let customer_id = document.getElementById('customer_id').value;
                        let queue_name = document.getElementById('queue_name').value;
                        let charging_source = document.getElementById('charging_source').value;
                        let verfication = document.getElementById('verfication').value;
                        let companycard = document.getElementById('companycard').value;
                        let cardnum = document.getElementById('cardnum').value;
                        let voucher = document.getElementById('voucher').value;
                        let amount = document.getElementById('amount').value;
                        let remarks = document.getElementById('remarks').value;

                        // Send FormData AJAX request
                        $.ajax({
                          url: '/api/bookingstatus',
                          type: 'json',
                          method: "post",
                          data: { payment_status: payment_status, card_holder_name: card_holder_name, customer_id: customer_id, queue_name: queue_name, charging_source: charging_source, verfication: verfication, companycard: companycard, cardnum: cardnum, voucher: voucher, amount: amount, remarks: remarks },
                          success: function (res) {
                            if (res.success) {
                              iziToast.success({
                                title: "Success",
                                message: "Booking Status Updated !!",
                                position: "topRight"
                              });
                            }
                          },
                        });


                      })
                    </script>

                    <script>

                      let uploadedFiles = {};

                      function clearSelectOptions() {
                        const select = document.getElementById("eticketfile");
                        while (select.options.length > 1) {
                          select.remove(1);
                        }
                      }

                      function addUploadedFile(fileName, file) {
                        // Add to uploadedFiles object
                        uploadedFiles[fileName] = file;

                        // Clear existing options first
                        clearSelectOptions();

                        // Add all files from uploadedFiles object
                        const select = document.getElementById("eticketfile");
                        Object.keys(uploadedFiles).forEach(name => {
                          let option = document.createElement("option");
                          option.value = name;
                          option.textContent = name;
                          select.appendChild(option);
                        });
                      }

                      document.getElementById("uploadForm").addEventListener("click", function (event) {
                        event.preventDefault();

                        let fileInput = document.getElementById("fileInput");
                        let fileNameInput = document.getElementById("fileName");

                        if (fileInput.files.length === 0) {
                          alert("Please select a file to upload.");
                          return;
                        }

                        let file = fileInput.files[0];
                        let fileName = fileNameInput.value || file.name;
                        let fileURL = URL.createObjectURL(file);

                        // Add to eTicketsList
                        let eTicketItem = document.createElement("div");
                        eTicketItem.className = "list-group-item";
                        eTicketItem.innerHTML = `
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <b>Filename:</b>
        <a href="${fileURL}" target="_blank">${fileName}</a>
        <small class="text-muted d-block">(${new Date().toISOString().split("T")[0]})</small>
      </div>
      <div class="deleterow btn-lg text-danger" onclick="removeItem(this, '${fileName}')">
        <i class="fa fa-times-circle"></i>
      </div>
    </div>
  `;
                        document.getElementById("eTicketsList").appendChild(eTicketItem);

                        // Clone to attachmentsList
                        let attachmentItem = eTicketItem.cloneNode(true);
                        document.getElementById("attachmentsList").appendChild(attachmentItem);

                        // Add to select options
                        addUploadedFile(fileName, file);

                        // Reset form
                        fileInput.value = "";
                        fileNameInput.value = "";
                      });


                      function removeItem(element, fileName) {
                        // Remove the visual elements
                        element.parentElement.parentElement.remove();

                        // Remove from uploadedFiles object
                        delete uploadedFiles[fileName];

                        // Update select options
                        clearSelectOptions();
                        Object.keys(uploadedFiles).forEach(name => {
                          let select = document.getElementById("eticketfile");
                          let option = document.createElement("option");
                          option.value = name;
                          option.textContent = name;
                          select.appendChild(option);
                        });
                      }

                      // email

                    </script>
                    <script>
                      let MailSendButton = document.getElementById('MailSendButton');
                      MailSendButton.addEventListener('click', async (e) => {
                        e.preventDefault();
                        MailSendButton.disabled = true

                        $('.loader').fadeIn('slow')

                        let selectedEmailType = document.querySelector('input[name="emailtype"]:checked').value;
                        let fromEmail = document.getElementById('fromemail').value;
                        let Emailsubject = document.getElementById('mailsubject').value;
                        let toEmail = document.getElementById('email').value;
                        let customer_id = document.getElementById('customer_id').value;

                        if (selectedEmailType === 'ticket') {
                          const formData = new FormData();
                          formData.append('fromEmail', fromEmail);
                          formData.append('subject', Emailsubject);
                          formData.append('toEmail', toEmail);
                          formData.append('emailtype', selectedEmailType);
                          formData.append('customer_id', customer_id);

                          let eticketSelect = document.getElementById('eticketfile');
                          let selectedFiles = Array.from(eticketSelect.selectedOptions);

                          selectedFiles.forEach(option => {
                            if (uploadedFiles[option.value]) {
                              formData.append('files', uploadedFiles[option.value]);
                            }
                          });

                          // Send FormData AJAX request
                          $.ajax({
                            url: '/api/send_email',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: handleResponse,
                            error: handleError
                          });
                        } else {
                          $.ajax({
                            url: '/api/send_email',
                            type: 'POST',
                            data: {
                              fromEmail,
                              subject: Emailsubject,
                              toEmail,
                              emailtype: selectedEmailType,
                              customer_id
                            },
                            success: handleResponse,
                            error: handleError
                          });
                        }
                      });

                      // Success handler
                      function handleResponse(response) {
                        $('#closeModal').close();
                        $('.loader').fadeOut('slow')
                        if (response.success) {
                          iziToast.success({
                            title: "Success",
                            message: "Email Sent Succesfully !!",
                            position: "topRight"
                          });
                        } else {
                          iziToast.error({
                            title: "Error",
                            message: response.message || "Email not sent!",
                            position: "topRight"
                          });
                        }
                        // setTimeout(() => {
                        //   window.location.reload();
                        // }, 2000);
                      }

                      // Error handler
                      function handleError(error) {
                        $('.loader').fadeOut('slow')
                        iziToast.error({
                          title: "Error",
                          message: "Something went wrong! Please try again.",
                          position: "topRight"
                        });
                      }

                      // Show/hide e-ticket file selection based on email type
                      document.querySelectorAll('input[name="emailtype"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                          const eticketFileDiv = document.getElementById('eticketfile').closest('.col-sm-12');
                          if (e.target.value === 'ticket') {
                            eticketFileDiv.style.display = 'block';
                          } else {
                            eticketFileDiv.style.display = 'none';
                          }
                        });
                      });

                      // Trigger initial state
                      document.querySelector('input[name="emailtype"]:checked')
                        .dispatchEvent(new Event('change'));

                      // update currency
                      document.addEventListener("DOMContentLoaded", function () {
                        let updateCurrencyBtn = document.getElementById('changeCurrencyBtn');

                        if (updateCurrencyBtn) {
                          updateCurrencyBtn.addEventListener('click', (e) => {
                            e.preventDefault();

                            let customer_id = document.getElementById('customer_id')?.value;
                            let currency = document.getElementById('currency')?.value;


                            $.ajax({
                              url: '/api/update_currency',
                              method: 'POST',
                              data: { customer_id, currency },
                              success: (response) => {
                                if (response.success) {
                                  iziToast.success({
                                    title: "Success",
                                    message: "Currency updated successfully!",
                                    position: "topRight"
                                  });
                                  setTimeout(() => {
                                    window.location.reload();
                                  }, 500);
                                } else {
                                  iziToast.warning({ title: "Warning", message: "Currency update failed. Try again." });
                                }
                              },
                              error: (error) => {
                                iziToast.error({ title: "Error", message: "Something went wrong! Please try again." });
                                console.log(error);
                              }
                            });
                          });
                        } else {
                          console.error("Button with ID 'changeCurrencyBtn' not found.");
                        }
                      });





                      let change_status = document.getElementById('change_status')

                      change_status.addEventListener('click', () => {
                        let customer_id = document.getElementById('customer_id').value;

                        $.ajax({
                          url: '/api/change_status',
                          type: 'POST',
                          dataType: 'json',
                          data: { customer_id },
                          success: function (res) {
                            if (res.success) {
                              iziToast.success({
                                title: "Success",
                                message: "Status changed successfully !!",
                                position: "topRight"
                              });
                              let changeStatusBtn = document.getElementById("change_status");
                              if (changeStatusBtn) {
                                changeStatusBtn.innerHTML = `<i class="fas fa-unlock"></i> Last Status: Sent For Issuance`;
                              }
                            }
                          }
                        })


                      })

                      let button = document.getElementById('alert_for_verfication');
                      button.addEventListener('click', () => {
                        iziToast.error({
                          title: "Error",
                          message: "Verify the Document First",
                          position: "topRight"
                        });
                      })
                    </script>


                    <!-- ----- ----------------------- Function to Send the Mail end----------------------- -->


                    <!-- General JS Scripts -->
                    <script src="/assets/js/app.min.js"></script>
                    <!-- JS Libraies -->
                    <script src="/assets/bundles/apexcharts/apexcharts.min.js"></script>
                    <!-- Page Specific JS File -->
                    <script src="/assets/js/page/index.js"></script>
                    <!-- Template JS File -->
                    <script src="/assets/js/scripts.js"></script>

                    <!-- Custom JS File -->
                    <script src="/assets/js/custom.js"></script>
                    <!-- JS Libraies -->

</body>


</html>